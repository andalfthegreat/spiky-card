<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spiky Card Generator</title>
  <meta name="description" content="Minimal Spiky card generator: X PFP + random trait, share to X." />
  <link rel="icon" href="data:," />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; }
    .card-glow { filter: drop-shadow(0 6px 28px rgba(168,85,247,.45)) drop-shadow(0 2px 8px rgba(0,0,0,.25)); }
    .inner-border { box-shadow: inset 0 0 0 1px rgba(0,0,0,.04), inset 0 0 24px rgba(0,0,0,.03); }
    .subtle-gradient { background: linear-gradient(180deg, rgba(255,255,255,.98) 0%, rgba(245,245,255,.96) 100%); }
  </style>
</head>
<body class="min-h-screen w-full bg-gradient-to-b from-purple-900 via-purple-950 to-black text-white">
  <main class="max-w-md mx-auto px-5 py-10">
    <header class="text-center mb-4">
      <h1 class="text-2xl font-semibold tracking-tight">Spiky Card Generator</h1>
      <!-- removed subtitle -->
    </header>

    <!-- STEP 1 -->
    <section id="step1" class="space-y-4">
      <div>
        <label class="text-xs uppercase tracking-wide opacity-70">Name</label>
        <input id="nameInput" type="text" placeholder="e.g., Mondalf"
               class="mt-1 w-full rounded-xl bg-white/5 border border-white/10 px-3 py-3 outline-none focus:ring-2 focus:ring-purple-500" />
      </div>

      <div>
        <label class="text-xs uppercase tracking-wide opacity-70">X handle</label>
        <input id="handleInput" type="text" placeholder="@yourhandle"
               class="mt-1 w-full rounded-xl bg-white/5 border border-white/10 px-3 py-3 outline-none focus:ring-2 focus:ring-purple-500" />
      </div>

      <button id="generateBtn"
              class="w-full rounded-xl bg-gradient-to-r from-purple-600 to-fuchsia-600 px-4 py-3 font-medium hover:opacity-90">
        Connect X & Generate
      </button>
      <p id="errorBox" class="text-[12px] text-red-300 min-h-[1.25rem]"></p>
    </section>

    <!-- STEP 2 -->
    <section id="step2" class="hidden">
      <!-- purple aura backdrop -->
      <div class="relative mt-6">
        <div class="absolute -inset-4 rounded-[28px] bg-gradient-to-br from-fuchsia-500/25 via-purple-500/25 to-fuchsia-500/10 blur-2xl"></div>

        <!-- the card -->
        <div id="card"
             class="relative rounded-[24px] p-5 subtle-gradient text-black inner-border card-glow">
          <!-- top row -->
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-14 h-14 rounded-xl overflow-hidden border border-black/10 bg-gray-100">
                <img id="avatarImg" alt="avatar" class="w-full h-full object-cover"
                     crossorigin="anonymous" referrerpolicy="no-referrer" />
              </div>
              <div class="min-w-0">
                <div id="outName" class="text-lg font-semibold leading-tight truncate">Anon Spiky</div>
              </div>
            </div>
            <!-- tiny corner badge -->
            <div class="shrink-0 w-8 h-8 grid place-items-center rounded-full bg-gradient-to-br from-purple-600 to-fuchsia-600 text-white text-xs font-semibold">
              ★
            </div>
          </div>

          <!-- trait block -->
          <div class="mt-4 pr-1">
            <div id="traitName" class="text-xl font-semibold leading-snug">Trait</div>
            <div id="traitDesc" class="text-sm opacity-80 mt-1">Description</div>
          </div>
        </div>
      </div>

      <button id="shareBtn"
              class="mt-5 w-full rounded-xl bg-white text-black font-medium px-4 py-3 hover:opacity-90">
        Share card to X
      </button>
      <p class="mt-2 text-[11px] opacity-60 text-center">
        If Share can’t attach the image, we’ll try the X app. If not installed, we open X on the web.
      </p>
      <p id="shareError" class="text-[12px] text-red-300 min-h-[1.25rem] text-center"></p>
    </section>
  </main>

  <!-- html-to-image -->
  <script src="https://unpkg.com/html-to-image@1.11.11/dist/html-to-image.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);

    // Traits
    const TRAITS = [
      { name: "Pixel Hater", description: "Refuses to admit pixel art is the highest artform, secretly collects anyway." },
      { name: "One-Pixel Maxi", description: "Believes all good art comes from a single square." },
      { name: "Go Straight to Jail", description: "Canonically imprisoned in the Spiky jail." },
      { name: "Spiky Maxi", description: "There is no other project. There is no other chain. SIU" },
      { name: "Chog Spy", description: "No one knows where your loyalty really lies." },
      { name: "Molandak’s Mistake", description: "You were there. Or maybe you were the mistake." },
      { name: "Flipper", description: "Never seen holding for more than 48 hours." },
      { name: "Utility Guy", description: "Keeps asking “but what’s the utility?”" },
      { name: "Monad Maxi", description: "Monad is religion. Preacher of finality." },
    ];
    const PRESET_TWEET = "I just generated my Spiky Card. Let’s build on Monad.";
    const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];

    /* Avatar fallbacks (no fetch, just <img> src chaining) */
    function buildAvatarURL(handle, provider) {
      const user = handle.replace(/^@/, "").trim();
      const base = provider
        ? `https://unavatar.io/${provider}/${encodeURIComponent(user)}`
        : `https://unavatar.io/${encodeURIComponent(user)}`;
      return `${base}?cb=${Date.now()}`;
    }
    function dicebearFallback(nameOrHandle) {
      const seed = encodeURIComponent((nameOrHandle || "anon").toLowerCase());
      return `https://api.dicebear.com/7.x/initials/svg?seed=${seed}&backgroundType=gradientLinear&radius=50&chars=2`;
    }
    function setAvatarWithFallbacks(handle, name) {
      const img = $("avatarImg");
      const order = [
        buildAvatarURL(handle, "x"),        // X first
        buildAvatarURL(handle, "twitter"),  // then twitter
        buildAvatarURL(handle, ""),         // bare
        dicebearFallback(name || handle || "anon"), // guaranteed
      ];
      let i = 0;
      img.onerror = () => { i++; if (i < order.length) img.src = order[i]; };
      img.src = order[0];
    }

    function generate() {
      const name = $("nameInput").value.trim() || "Anon Spiky";
      const handle = $("handleInput").value.trim();
      const errorBox = $("errorBox");
      errorBox.textContent = "";
      if (!handle) { errorBox.textContent = "Please enter your X handle."; return; }

      $("outName").textContent = name;
      setAvatarWithFallbacks(handle, name);

      const t = pick(TRAITS);
      $("traitName").textContent = t.name;
      $("traitDesc").textContent = t.description;

      $("step1").classList.add("hidden");
      $("step2").classList.remove("hidden");
    }

    async function shareToX() {
      const card = $("card");
      const shareError = $("shareError");
      shareError.textContent = "";

      try {
        const dataUrl = await htmlToImage.toPng(card, { cacheBust: true, pixelRatio: 2 });

        // 1) Prefer system share (image + text)
        try {
          const blob = await (await fetch(dataUrl)).blob();
          const file = new File([blob], "spiky-card.png", { type: "image/png" });
          const payload = { text: PRESET_TWEET, files: [file] };
          if (navigator.canShare && navigator.canShare(payload)) {
            await navigator.share(payload); // choose X app in the sheet
            return;
          }
        } catch {}

        // 2) Try to open X app with text (deep links)
        const deepLinks = [
          `x://post?text=${encodeURIComponent(PRESET_TWEET)}`,
          `twitter://post?message=${encodeURIComponent(PRESET_TWEET)}`,
        ];
        let tried = false;
        for (const url of deepLinks) {
          tried = true;
          try {
            window.location.href = url;
            setTimeout(() => {
              window.open(`https://x.com/intent/tweet?text=${encodeURIComponent(PRESET_TWEET)}`, "_blank");
            }, 1200);
            return;
          } catch {}
        }

        // 3) Web fallback
        if (!tried) {
          window.open(`https://x.com/intent/tweet?text=${encodeURIComponent(PRESET_TWEET)}`, "_blank");
        }
      } catch {
        shareError.textContent = "Couldn’t generate the image. Try again.";
      }
    }

    $("generateBtn").addEventListener("click", generate);
    $("shareBtn").addEventListener("click", shareToX);
  </script>
</body>
</html>
