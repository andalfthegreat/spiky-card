<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spiky Card Generator</title>
  <meta name="description" content="Minimal Spiky card generator: connect Twitter, auto-generate a card with your PFP + a random trait, share to Twitter." />
  <link rel="icon" href="data:," />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; }
    .inner-border { box-shadow: inset 0 0 0 2px rgba(255,255,255,0.08), inset 0 0 40px rgba(255,255,255,0.06); }
  </style>
</head>
<body class="min-h-screen w-full bg-gradient-to-b from-purple-900 via-purple-950 to-black text-white">
  <main class="max-w-md mx-auto px-5 py-10">
    <header class="text-center mb-8">
      <h1 class="text-2xl font-semibold tracking-tight">Spiky Card Generator</h1>
      <p class="mt-2 text-sm opacity-80">Minimal • Mobile-first • Purple</p>
    </header>

    <!-- STEP 1: name + handle + connect -->
    <section id="step1" class="space-y-4">
      <div>
        <label class="text-xs uppercase tracking-wide opacity-70">Name</label>
        <input id="nameInput" type="text" placeholder="e.g., Andalf"
               class="mt-1 w-full rounded-xl bg-white/5 border border-white/10 px-3 py-3 outline-none focus:ring-2 focus:ring-purple-500" />
      </div>

      <div>
        <label class="text-xs uppercase tracking-wide opacity-70">Twitter handle</label>
        <input id="handleInput" type="text" placeholder="@yourhandle"
               class="mt-1 w-full rounded-xl bg-white/5 border border-white/10 px-3 py-3 outline-none focus:ring-2 focus:ring-purple-500" />
      </div>

      <button id="connectBtn"
              class="w-full rounded-xl bg-gradient-to-r from-purple-600 to-fuchsia-600 px-4 py-3 font-medium hover:opacity-90">
        Connect & Generate
      </button>
      <p id="errorBox" class="text-[11px] text-red-300"></p>
      <p class="text-[11px] opacity-60 text-center">We just fetch your public avatar via handle. No real login.</p>
    </section>

    <!-- STEP 2: generated card + share -->
    <section id="step2" class="hidden">
      <div id="card"
           class="relative mt-6 rounded-[24px] p-5 bg-gradient-to-br from-purple-700 via-purple-800 to-fuchsia-700 border border-white/10 shadow-2xl overflow-hidden inner-border"
           style="aspect-ratio: 1.91/1;">
        <div class="absolute inset-0 pointer-events-none">
          <div class="absolute -top-16 -right-16 w-56 h-56 rounded-full bg-white/10 blur-3xl"></div>
          <div class="absolute bottom-0 left-0 right-0 h-24 bg-gradient-to-t from-black/30 to-transparent"></div>
        </div>

        <div class="relative flex items-center gap-4">
          <div id="pfpBox" class="w-16 h-16 rounded-2xl bg-black/30 overflow-hidden border border-white/20"></div>
          <div class="min-w-0">
            <div id="outName" class="text-lg font-semibold leading-tight truncate">Anon Spiky</div>
          </div>
        </div>

        <div class="mt-4 pr-2">
          <div id="traitName" class="text-xl font-semibold leading-snug">Trait</div>
          <div id="traitDesc" class="text-sm opacity-90 mt-1">Description</div>
        </div>

        <div class="absolute bottom-3 left-5 right-5 flex items-center justify-between text-[11px] opacity-75">
          <span>spiky.cards</span>
          <span>monad vibes</span>
        </div>
      </div>

      <button id="shareBtn"
              class="mt-5 w-full rounded-xl bg-white text-black font-medium px-4 py-3 hover:opacity-90">
        Share card to Twitter
      </button>
      <p class="mt-2 text-[11px] opacity-60 text-center">
        If your device can’t attach images via Share, the card downloads and a tweet opens with preset text.
      </p>
    </section>
  </main>

  <script src="https://unpkg.com/html-to-image@1.11.11/dist/html-to-image.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);

    // Traits (your list)
    const TRAITS = [
      { name: "Pixel Hater", description: "Refuses to admit pixel art is the highest artform, secretly collects anyway." },
      { name: "One-Pixel Maxi", description: "Believes all good art comes from a single square." },
      { name: "Go Straight to Jail", description: "Canonically imprisoned in the Spiky jail." },
      { name: "Spiky Maxi", description: "There is no other project. There is no other chain. SIU" },
      { name: "Chog Spy", description: "No one knows where your loyalty really lies." },
      { name: "Molandak’s Mistake", description: "You were there. Or maybe you were the mistake." },
      { name: "Flipper", description: "Never seen holding for more than 48 hours." },
      { name: "Utility Guy", description: "Keeps asking “but what’s the utility?”" },
      { name: "Monad Maxi", description: "Monad is religion. Preacher of finality." },
    ];

    const PRESET_TWEET = "I just generated my Spiky Card. Let’s build on Monad.";

    const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];

    async function getUnavatar(handle) {
      const user = handle.replace(/^@/, "").trim();
      const tryJson = async (provider) => {
        const url = `https://unavatar.io/${provider ? provider + "/" : ""}${encodeURIComponent(user)}.json`;
        const r = await fetch(url, { mode: "cors" });
        if (!r.ok) throw new Error("json fail");
        return r.json();
      };
      const tryImg = async (provider) => {
        const url = `https://unavatar.io/${provider ? provider + "/" : ""}${encodeURIComponent(user)}`;
        const r = await fetch(url, { mode: "cors" });
        if (!r.ok) throw new Error("img fail");
        return url;
      };

      // Try JSON first (for name), then image. Try providers: twitter → x → bare.
      const providers = ["twitter", "x", ""];
      for (const p of providers) {
        try {
          const j = await tryJson(p);
          return { img: j.url || await tryImg(p), name: j.name || "" };
        } catch (e) {
          try {
            const img = await tryImg(p);
            return { img, name: "" };
          } catch {}
        }
      }
      throw new Error("Could not fetch avatar.");
    }

    async function preload(url) {
      await new Promise((res, rej) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => res();
        img.onerror = () => rej(new Error("Avatar failed to load"));
        img.src = url + (url.includes("?") ? "&" : "?") + "cb=" + Date.now();
      });
    }

    async function connectAndGenerate() {
      const name = $("nameInput").value.trim() || "Anon Spiky";
      const handle = $("handleInput").value.trim();
      const errorBox = $("errorBox");
      errorBox.textContent = "";

      if (!handle) {
        errorBox.textContent = "Please enter your Twitter handle.";
        return;
      }

      try {
        const { img, name: nameHint } = await getUnavatar(handle);
        await preload(img);

        // Render card
        $("outName").textContent = name || nameHint || handle;
        const pfpBox = $("pfpBox");
        pfpBox.innerHTML = "";
        const el = document.createElement("img");
        el.src = img;
        el.alt = "avatar";
        el.crossOrigin = "anonymous";
        el.className = "w-full h-full object-cover";
        pfpBox.appendChild(el);

        const t = pick(TRAITS);
        $("traitName").textContent = t.name;
        $("traitDesc").textContent = t.description;

        // Show step 2
        $("step1").classList.add("hidden");
        $("step2").classList.remove("hidden");
      } catch (e) {
        errorBox.textContent = "Couldn’t fetch avatar. Double-check the handle or try again.";
      }
    }

    async function shareToTwitter() {
      const card = $("card");
      try {
        const dataUrl = await htmlToImage.toPng(card, { cacheBust: true, pixelRatio: 2 });
        const blob = await (await fetch(dataUrl)).blob();
        const file = new File([blob], "spiky-card.png", { type: "image/png" });

        const payload = { text: PRESET_TWEET, files: [file] };
        if (navigator.canShare && navigator.canShare(payload)) {
          await navigator.share(payload); // choose Twitter in share sheet
          return;
        }

        // Fallback: download + open tweet intent with text
        const a = document.createElement("a");
        a.href = dataUrl; a.download = "spiky-card.png";
        document.body.appendChild(a); a.click(); a.remove();
        const intent = `https://twitter.com/intent/tweet?text=${encodeURIComponent(PRESET_TWEET)}`;
        window.open(intent, "_blank");
      } catch {
        const intent = `https://twitter.com/intent/tweet?text=${encodeURIComponent(PRESET_TWEET)}`;
        window.open(intent, "_blank");
      }
    }

    $("connectBtn").addEventListener("click", connectAndGenerate);
    $("shareBtn").addEventListener("click", shareToTwitter);
  </script>
</body>
</html>
